<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<title>Embedding C & Rust in Ruby</title>
<link href="../../../assets/stylesheets/application.css" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Radley:400,400italic" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" />
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
</head>
<body class='type-system-traditional'>
<div class='blog-wrapper'>
<nav>
<ul class='nav-left'>
<li class='menu-item'>
<span id='namesake'>Cody Roberts</span>
</li>
</ul>
<ul class='nav-right'>
<li>
<span class='menu-item'>
<a href="/blog">blog</a>
</span>
</li>
<li>
<span class='menu-item'>
<a href="/about">about</a>
</span>
</li>
<li>
<span class='menu-item'>
<a href="/projects">projects</a>
</span>
</li>
<li id='hamburger'>
<span class='menu-item'>
<i class='fa fa-bars'></i>
</span>
</li>
</ul>
</nav>

<div class='post-archive'>
<p class='type'>Articles</p>
<div class='post-archive-item'>
<a href="/blog/article/ember-data-in-components/">Ember Data & Components</a>
</div>
<div class='post-archive-item'>
<a href="/blog/article/streams-vs-enums/">Streams, Enums, and Protocols!</a>
</div>
<div class='post-archive-item'>
<a href="/blog/article/a-tour-of-phoenix/">A Tour of Phoenix</a>
</div>
<br>
<p class='type'>Today I Learned</p>
<div class='post-archive-item'>
<a href="/blog/til/comprehensions/">Elixir Comprehensions</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/gen-server/">What is GenServer?</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/elixir-structs/">Elixir Structs</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/atoms/">Elixir Atoms</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/squashing-commits/">Squashing Commits</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/the-reverse-splat/">Ruby's Reverse Splat</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/railroady-uml-diagrams/">Railroady</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/embedding-in-ruby/">Embedding C & Rust in Ruby</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/using-gits-interactive-staging/">Git Interactive</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/select-random-rails-record/">ActiveRecord Random</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/manage-multiple-tmux-sessions/">Tmux Sessions</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/focused-splits/">Focused Splits</a>
</div>

</div>
<div class='post-wrapper'>
<div class='post-header'>
<p class='date'>Aug 29, 2015</p>
<h2>Embedding C & Rust in Ruby</h2>
<hr>
</div>
<div class='post-content'>
<p>With the introduction of Fiddle into Ruby 1.9.x, it's pretty simple to embed
C(C++) and Rust into a Ruby program.  The following practically useless example
compiles both Rust and Cpp files into shared object files which can then be
imported by Fiddle for use in the Ruby file.</p>

<h2 id="rust">Rust</h2>
<p>create rust.rs</p>

<pre class="highlight c"><code><span class="c1">//rust.rs
</span><span class="cp">#[no_mangle] // prevent linker from mangling function names
</span><span class="n">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="n">fn</span> <span class="n">rust_calc</span><span class="p">(</span><span class="n">a</span><span class="o">:</span> <span class="n">i32</span><span class="p">,</span> <span class="n">b</span><span class="o">:</span> <span class="n">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">i32</span> <span class="p">{</span>
  <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="p">}</span>
</code></pre>

<p>then compile…</p>

<pre class="highlight shell"><code><span class="gp">$ </span>rustc rust.rs --crate-type<span class="o">=</span>dylib
</code></pre>

<p>Note: on some systems the shared object file will have extension .dylib</p>

<h2 id="c--c">C / C++</h2>
<p>create calc.cpp</p>

<pre class="highlight c"><code><span class="c1">//calc.cpp
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cpp_calc</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>then compile…</p>

<pre class="highlight shell"><code><span class="gp">$ </span>g++ -c -fPIC -o calc.o calc.cpp
<span class="gp">$ </span>g++ -shared -o libcpp.so calc.o
</code></pre>

<h2 id="ruby">Ruby</h2>

<p>There should now be both a librust.so and libcpp.so in your current directory.</p>

<p>create embed.rb</p>

<pre class="highlight ruby"><code><span class="c1">#embed.rb</span>

<span class="nb">require</span> <span class="s1">'fiddle'</span>
<span class="nb">require</span> <span class="s1">'fiddle/import'</span>

<span class="k">module</span> <span class="nn">EmbedRust</span>
  <span class="kp">extend</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">Importer</span>

  <span class="n">dlload</span> <span class="s1">'./librust.so'</span>

  <span class="n">extern</span> <span class="s2">"int rust_calc(int, int)"</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">EmbedCpp</span>
  <span class="kp">extend</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">Importer</span>

  <span class="n">dlload</span> <span class="s1">'./libcpp.so'</span>

  <span class="n">extern</span> <span class="s2">"int cpp_calc(int, int)"</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">"Rust: </span><span class="si">#{</span><span class="no">EmbedRust</span><span class="p">.</span><span class="nf">rust_calc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"Cpp: </span><span class="si">#{</span><span class="no">EmbedCpp</span><span class="p">.</span><span class="nf">cpp_calc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</code></pre>

<p>That's it!  Obviously this example is trivial, and you gain next to nothing by
using Rust or C.  However if you need a performance increase, or have an
existing library it could be pretty handy.</p>

</div>
<div class='post-comment'>
<div id='disqus_thread'></div>
<script>
  var disqus_shortname = 'bloomytil';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

</div>

</div>
</div>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="../../../assets/javascripts/application.js"></script>
</body>
</html>
