<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<title>Phoenix Channels with EmberJS</title>
<link href="../../assets/stylesheets/application.css" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Radley:400,400italic" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" />
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
</head>
<body class='type-system-traditional'>
<p>For this tutorial I am using
Elixir v1.1.2
Phoenix v1.2.3</p>

<h2 id="phoenix-api">Phoenix API</h2>

<p>The first thing we'll do is initialize our Phoenix application.  We are skipping
brunch, an asset build tool, because we will be doing our front end seperately
with EmberJS.</p>

<pre class="highlight plaintext"><code>mix phoenix.new truckn --no-brunch
cd truckn
</code></pre>

<p>Install the dependencies when prompted and then go ahead and initialize your git
repository.</p>

<pre class="highlight shell"><code>git init
git add -A
git commit -m <span class="s2">"init"</span>
</code></pre>

<p>Since we'll be using the JSONAPI.org standard we can go ahead and add the
ja_serializer library to our dependencies.</p>

<pre class="highlight elixir"><code><span class="c1">#mix.exs</span>

<span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.1.3"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_ecto</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:postgrex</span><span class="p">,</span> <span class="sd">"</span><span class="s2">&gt;= 0.0.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.3"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:dev</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.9"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:ja_serializer</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.8.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}]</span>
<span class="k">end</span>
</code></pre>

<p>Run mix deps.get to install the library.</p>

<p>Lets configure Plug to accept our JSON-API MIME type.  And json-api to be
seralized with Poison.</p>

<pre class="highlight elixir"><code><span class="c1">#config/config.exs</span>

<span class="c1"># Configure json-api to use Poison</span>
<span class="n">config</span> <span class="ss">:phoenix</span><span class="p">,</span> <span class="ss">:format_encoders</span><span class="p">,</span>
  <span class="sd">"</span><span class="s2">json-api"</span><span class="p">:</span> <span class="no">Poison</span>

<span class="c1"># Configure Plug for JSON-API</span>
<span class="n">config</span> <span class="ss">:plug</span><span class="p">,</span> <span class="ss">:mimes</span><span class="p">,</span> <span class="p">%{</span>
  <span class="sd">"</span><span class="s2">application/vnd.api+json"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="sd">"</span><span class="s2">json-api"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>

<p>Now we will set up our router for json-api, namespaced by version.  We add a few
plugs to the :api pipeline.</p>

<p><strong>JaSerializer.ContentTypeNegotiation</strong>
to enforce json-api standard content-type/accept headers and add the response
content-type</p>

<p><strong>JaSerializer.Deserializer</strong>
to normalize attributes to underscores</p>

<pre class="highlight elixir"><code><span class="c1">#web/router.ex</span>

<span class="n">pipeline</span> <span class="ss">:api</span> <span class="k">do</span>
  <span class="n">plug</span> <span class="ss">:accepts</span><span class="p">,</span> <span class="p">[</span><span class="sd">"</span><span class="s2">json-api"</span><span class="p">]</span>
  <span class="n">plug</span> <span class="no">JaSerializer</span><span class="o">.</span><span class="no">ContentTypeNegotiation</span>
  <span class="n">plug</span> <span class="no">JaSerializer</span><span class="o">.</span><span class="no">Deserializer</span>
<span class="k">end</span>

<span class="n">scope</span> <span class="sd">"</span><span class="s2">/api"</span><span class="p">,</span> <span class="no">Truckn</span> <span class="k">do</span>
  <span class="n">pipe_through</span> <span class="ss">:api</span>

  <span class="n">scope</span> <span class="sd">"</span><span class="s2">/v1"</span> <span class="k">do</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Lets add our changes and commit.</p>

<pre class="highlight shell"><code>git add mix.exs web/router.ex config/config.exs
git commit -m <span class="s2">"Set up for JSONAPI.org standard"</span>
</code></pre>

<p>Alright now that we have our api configured for JSONAPI.org standard lets set up
our models. We'll start with our users.  Lets add Guardian and Comeonin to our
dependencies, we'll use them for authentication and encryption.  We'll also need
to add :comeonin as an application (runtime) dependency.</p>

<pre class="highlight elixir"><code><span class="c1">#mix.exs</span>

<span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span><span class="ss">mod:</span> <span class="p">{</span><span class="no">Truckn</span><span class="p">,</span> <span class="p">[]},</span>
    <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="ss">:phoenix_html</span><span class="p">,</span> <span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:gettext</span><span class="p">,</span>
                  <span class="ss">:phoenix_ecto</span><span class="p">,</span> <span class="ss">:postgrex</span><span class="p">,</span> <span class="ss">:comeonin</span><span class="p">]]</span>
<span class="k">end</span>

<span class="o">...</span>

<span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.1.3"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_ecto</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:postgrex</span><span class="p">,</span> <span class="sd">"</span><span class="s2">&gt;= 0.0.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.3"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:dev</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.9"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:ja_serializer</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.8.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:comeonin</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.1.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:guardian</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.10.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}]</span>
<span class="k">end</span>
</code></pre>

<p>You know the drillâ€¦ mix deps.get to install the dependencies.</p>

<p>Now we can configure Guardian.  Add the following to our config file. We haven't
created our serializer yet but we will shortly.</p>

<pre class="highlight elixir"><code><span class="c1">#config/config.exs</span>

<span class="c1"># Configure guardian</span>
<span class="n">config</span> <span class="ss">:guardian</span><span class="p">,</span> <span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">allowed_algos:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">HS512"</span><span class="p">],</span>
  <span class="ss">verify_module:</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">JWT</span><span class="p">,</span>
  <span class="ss">issuer:</span> <span class="sd">"</span><span class="s2">Truckn"</span><span class="p">,</span>
  <span class="ss">ttl:</span> <span class="p">{</span> <span class="m">3</span><span class="p">,</span> <span class="ss">:days</span> <span class="p">},</span>
  <span class="ss">verify_issuer:</span> <span class="no">true</span><span class="p">,</span>
  <span class="ss">secret_key:</span> <span class="n">to_string</span><span class="p">(</span><span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">),</span>
  <span class="ss">permissions:</span> <span class="p">%{</span>
    <span class="ss">default:</span> <span class="p">[</span><span class="ss">:read</span><span class="p">,</span> <span class="ss">:write</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="ss">serializer:</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">GuardianSerializer</span>
</code></pre>

<p>Create our users using the handy json generator.</p>

<pre class="highlight shell"><code>mix phoenix.gen.json User users name:string password:string password_hash:string
</code></pre>

<p>This will scaffold out our migration, model, controller, and json views.
Luxury. After it's done open up the create_users migration, we'll be adding a
few things.  We'll want to create a unique index for our emails (login) as well
as make our password virtual since we won't be storing it.</p>

<pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Repo</span><span class="o">.</span><span class="no">Migrations</span><span class="o">.</span><span class="no">CreateUser</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Migration</span>

  <span class="k">def</span> <span class="n">change</span> <span class="k">do</span>
    <span class="n">create</span> <span class="n">table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">add</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>
      <span class="n">add</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>
      <span class="n">add</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">virtual:</span> <span class="no">true</span>
      <span class="n">add</span> <span class="ss">:password_hash</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>

      <span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">create</span> <span class="n">unique_index</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We'll also want to open up the User model and add some constraints and a
function to encrypt the virtual password. First we'll remove password_hash as a
required field.  Then we'll add the following constraints:</p>

<pre class="highlight elixir"><code><span class="k">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span> <span class="p">\\</span> <span class="ss">:empty</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">model</span>
  <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nv">@required_fields</span><span class="p">,</span> <span class="nv">@optional_fields</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">validate_format</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="sr">~r/@/</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">validate_length</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">min:</span> <span class="m">5</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">validate_confirmation</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">message:</span> <span class="sd">"</span><span class="s2">Incorrect password"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">unique_constraint</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">message:</span> <span class="sd">"</span><span class="s2">Email in use"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">generate_password_hash</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">changeset</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">changeset</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Ecto</span><span class="o">.</span><span class="no">Changeset</span><span class="p">{</span><span class="ss">valid?:</span> <span class="no">true</span><span class="p">,</span> <span class="ss">changes:</span> <span class="p">%{</span><span class="ss">password:</span> <span class="n">password</span><span class="p">}}</span> <span class="o">-&gt;</span>
      <span class="n">put_change</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="ss">:password_hash</span><span class="p">,</span> <span class="no">Comeonin</span><span class="o">.</span><span class="no">Bcrypt</span><span class="o">.</span><span class="n">hashpwsalt</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">-&gt;</span>
      <span class="n">changeset</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>generate_password_hash/1 is a simple function that generates an encrypted password
from the given password upon change to the model.</p>

<p>Let's clean up some of this generated mess.  We can delete our Page controller,
view, and template, and the associating tests.  We should move our new User
controller to controller/api/v1/. Next we'll create our Session controller.  The
Session controller will be handing out our JWTs.</p>

<pre class="highlight elixir"><code><span class="c1">#web/controllers/api/v1/session_controller.ex</span>

<span class="k">defmodule</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">SessionController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="n">plug</span> <span class="ss">:scrub_params</span><span class="p">,</span> <span class="sd">"</span><span class="s2">session"</span> <span class="ow">when</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="ss">:create</span><span class="p">]</span>

  <span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">session"</span> <span class="o">=&gt;</span> <span class="n">session_params</span><span class="p">})</span> <span class="k">do</span>
    <span class="k">case</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Session</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">session_params</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">_full_claims</span><span class="p">}</span> <span class="o">=</span> <span class="n">user</span> <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="n">encode_and_sign</span><span class="p">(</span><span class="ss">:token</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">Map</span><span class="o">.</span><span class="n">put_new</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:jwt</span><span class="p">,</span> <span class="n">jwt</span><span class="p">)</span>

        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:created</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">show.json"</span><span class="p">,</span> <span class="ss">data:</span> <span class="n">user</span><span class="p">)</span>
      <span class="ss">:error</span> <span class="o">-&gt;</span>
        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:unprocessable_entity</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">error.json"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">unauthenticated</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:forbidden</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">Truckn</span><span class="o">.</span><span class="no">SessionView</span><span class="p">,</span> <span class="sd">"</span><span class="s2">forbidden.json"</span><span class="p">,</span> <span class="ss">error:</span> <span class="sd">"</span><span class="s2">Not Authenticated"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We'll need to create a new helper module to help authenticate our session.
Comeonin gives us a handy checkpw/2 function so we can compare the user given
password with our hash stored in the database.</p>

<p>~~elixir
#web/helpers/session.ex</p>

<p>defmodule Truckn.Session do
  alias Truckn.{Repo, User}</p>

<p>def authenticate(%{"email" =&gt; email, "password" =&gt; password}) do
    user = Repo.get_by(User, email: String.downcase(email))</p>

<pre class="highlight plaintext"><code>case check_password(user, password) do
  true -&gt; {:ok, user}
  _ -&gt; :error
end   end
</code></pre>

<p>defp check_password(user, password) do
    case user do
      nil -&gt; false
      _ -&gt; Comeonin.Bcrypt.checkpw(password, user.password_hash)
    end
  end
end
~~~</p>

<p>We'll need a view for our Session.  We'll have three responses, one
for success, invalid credentials, and forbidden access. Notice that we include
a line for attributes.  This is for ja_serializer (TODO).</p>

<pre class="highlight elixir"><code><span class="c1">#web/views/session_view.ex</span>

<span class="k">defmodule</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">SessionView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:view</span>

  <span class="n">attributes</span> <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:jwt</span><span class="p">]</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">show.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">user:</span> <span class="n">user</span><span class="p">})</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">data:</span> <span class="n">render_one</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">SessionView</span><span class="p">,</span> <span class="sd">"</span><span class="s2">user.json"</span><span class="p">)}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">error.json"</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">error:</span> <span class="sd">"</span><span class="s2">Invalid email or password"</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">forbidden.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">error:</span> <span class="n">error</span><span class="p">})</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">error:</span> <span class="n">error</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">user.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">user:</span> <span class="n">user</span><span class="p">})</span> <span class="k">do</span>
    <span class="p">%{</span>
      <span class="ss">id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
      <span class="ss">name:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="ss">email:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
      <span class="ss">jwt:</span> <span class="n">user</span><span class="o">.</span><span class="n">jwt</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In order for us to use ja_serializer we'll have to use
JaSerializer.PhoenixView in our view.  Since we'll be using it for all of our
views we can just add it to web/web.ex.</p>

<pre class="highlight elixir"><code><span class="c1">#web/web.ex</span>

<span class="k">def</span> <span class="n">view</span> <span class="k">do</span>
  <span class="kn">quote</span> <span class="k">do</span>
    <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">View</span><span class="p">,</span> <span class="ss">root:</span> <span class="sd">"</span><span class="s2">web/templates"</span>
    <span class="kn">use</span> <span class="no">JaSerializer</span><span class="o">.</span><span class="no">PhoenixView</span>

    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>For now our only user will be the Admin. Because of this we won't need most of
our User controller, so let's slim that down.  We could have just created these
files ourselves, it's down to preference.</p>

<pre class="highlight elixir"><code><span class="c1">#web/controllers/api/v1/user_controller.ex</span>

<span class="k">defmodule</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">UserController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="n">alias</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">User</span>

  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">EnsureAuthenticated</span><span class="p">,</span> <span class="ss">handler:</span> <span class="no">Truckin</span><span class="o">.</span><span class="no">SessionController</span>

  <span class="k">def</span> <span class="n">show</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">decode_and_verify_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_claims</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">show.json"</span><span class="p">,</span> <span class="ss">data:</span> <span class="n">user</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_reason</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:not_found</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">Truckin</span><span class="o">.</span><span class="no">SessionView</span><span class="p">,</span> <span class="sd">"</span><span class="s2">error.json"</span><span class="p">,</span> <span class="ss">error:</span> <span class="sd">"</span><span class="s2">Not found"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">decode_and_verify_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_token</span>
    <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="n">decode_and_verify</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We're only going to expose show to the API for now.  This way we can get the
currently logged in user.</p>

<p>Next let's add the Guardian serializer to lib.</p>

<pre class="highlight elixir"><code><span class="c1">#lib/truckn/guardian_serializer.ex</span>

<span class="k">defmodule</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">GuardianSerializer</span> <span class="k">do</span>
  <span class="nv">@behaviour</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Serializer</span>

  <span class="n">alias</span> <span class="no">Truckn</span><span class="o">.</span><span class="p">{</span><span class="no">Repo</span><span class="p">,</span> <span class="no">User</span><span class="p">}</span>

  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="p">%</span><span class="no">User</span><span class="p">{}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">User:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>

  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="sd">"</span><span class="s2">User:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="no">String</span><span class="o">.</span><span class="n">to_integer</span><span class="p">(</span><span class="n">id</span><span class="p">))}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>

<p>And finally we can set up our router to post sessions and show users.  We'll
also need to add a few plugs to our pipeline.</p>

<pre class="highlight elixir"><code><span class="c1">#web/router.ex</span>

<span class="n">pipeline</span> <span class="ss">:api</span> <span class="k">do</span>
  <span class="n">plug</span> <span class="ss">:accepts</span><span class="p">,</span> <span class="p">[</span><span class="sd">"</span><span class="s2">json-api"</span><span class="p">]</span>
  <span class="n">plug</span> <span class="no">JaSerializer</span><span class="o">.</span><span class="no">ContentTypeNegotiation</span>
  <span class="n">plug</span> <span class="no">JaSerializer</span><span class="o">.</span><span class="no">Deserializer</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyHeader</span><span class="p">,</span> <span class="ss">realm:</span> <span class="sd">"</span><span class="s2">Bearer"</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">LoadResource</span>
<span class="k">end</span>

<span class="n">scope</span> <span class="sd">"</span><span class="s2">/api"</span><span class="p">,</span> <span class="no">Truckn</span> <span class="k">do</span>
  <span class="n">pipe_through</span> <span class="ss">:api</span>

  <span class="n">scope</span> <span class="sd">"</span><span class="s2">/v1"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="sd">"</span><span class="s2">/users"</span><span class="p">,</span> <span class="no">UserController</span><span class="p">,</span> <span class="ss">:show</span>

    <span class="n">post</span> <span class="sd">"</span><span class="s2">/sessions"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:create</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Ok we're about ready to migrate, but before we do you may need to specifiy a
different postgresql template in config/dev.exs.  I'm on Ubuntu and the default
template isn't UTF8. If this is the case for you just specify template0.</p>

<pre class="highlight elixir"><code><span class="c1">#config/dev.exs</span>

<span class="c1"># Configure your database</span>
<span class="n">config</span> <span class="ss">:truckn</span><span class="p">,</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span>
  <span class="ss">adapter:</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Postgres</span><span class="p">,</span>
  <span class="ss">username:</span> <span class="sd">"</span><span class="s2">postgres"</span><span class="p">,</span>
  <span class="ss">password:</span> <span class="sd">"</span><span class="s2">postgres"</span><span class="p">,</span>
  <span class="ss">database:</span> <span class="sd">"</span><span class="s2">truckn_dev"</span><span class="p">,</span>
  <span class="ss">hostname:</span> <span class="sd">"</span><span class="s2">localhost"</span><span class="p">,</span>
  <span class="ss">template:</span> <span class="sd">"</span><span class="s2">template0"</span><span class="p">,</span>
  <span class="ss">pool_size:</span> <span class="m">10</span>
</code></pre>

<p>Alright since we didn't add any way to register over the API we'll just seed our
database with an admin user. Replace the contents of seeds.ex with the
following.</p>

<pre class="highlight elixir"><code><span class="c1">#priv/repo/seeds.ex</span>

<span class="n">alias</span> <span class="no">Truckn</span><span class="o">.</span><span class="p">{</span><span class="no">Repo</span><span class="p">,</span> <span class="no">User</span><span class="p">}</span>

<span class="n">admin</span> <span class="o">=</span> <span class="p">%{</span> <span class="ss">name:</span> <span class="sd">"</span><span class="s2">Admin"</span><span class="p">,</span> <span class="ss">email:</span> <span class="sd">"</span><span class="s2">admin@truckn.com"</span><span class="p">,</span> <span class="ss">password:</span> <span class="sd">"</span><span class="s2">password"</span> <span class="p">}</span>
<span class="no">User</span><span class="o">.</span><span class="n">changeset</span><span class="p">(%</span><span class="no">User</span><span class="p">{},</span> <span class="n">admin</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Repo</span><span class="o">.</span><span class="n">insert!</span>
</code></pre>

<p>We should be able to migrate now.  You can use the alias ecto.setup defined in
mix.exs.  It will create, migrate, and seed the database.</p>

<pre class="highlight shell"><code>mix ecto.setup
</code></pre>

<p>If everything went well we should be able to run our server and create a
session! Spin up the server and request a token. I use Postman(TODO), but here's 
a curl request for convience.</p>

<pre class="highlight shell"><code>mix phoenix.server

curl --request POST <span class="se">\</span>
  --url <span class="s1">'http://localhost:4000/api/v1/sessions?session%5Bpassword%5D=password&amp;session%5Bemail%5D=admin%40truckn.com'</span> <span class="se">\</span>
  --header <span class="s1">'accept: application/vnd.api+json'</span> <span class="se">\</span>
  --header <span class="s1">'content-type: application/vnd.api+json'</span>
</code></pre>

<p>Hopefully it worked =). Here's what I got</p>

<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"jsonapi"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"session"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Admin"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"jwt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJVc2VyOjEiLCJleHAiOjE0NjA0OTQ0MjQsImlhdCI6MTQ2MDIzNTIyNCwiaXNzIjoiVHJ1Y2tuIiwianRpIjoiMTE2NjJiYjgtODcwYS00MDU5LTg5ZDQtOTI1NjJkZjQ3MzJkIiwicGVtIjp7fSwic3ViIjoiVXNlcjoxIiwidHlwIjoidG9rZW4ifQ.q0b7xAYa04ADCzP2onK7UZqnsDLH4iE6dqntSJ3biogmKFrhu9JXa-QdmPzxzKGpp36tYbK3ujdLitSUPpkEGg"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin@truckn.com"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Lookin good. Lets commit this sucker. I recommend using git's interactive add,
it's the best thing since Montgomery's Cheddar.</p>

<pre class="highlight shell"><code>git add -i
git commit -m <span class="s2">"Add User and Session"</span>
</code></pre>

<p>Now that our authentication is working, we can set up our Truck model. Since
we'll need a controller and a view in addition to the model, we should just use
the provided json generator.</p>

<pre class="highlight shell"><code>mix phoenix.gen.json Truck trucks name:string menu:array:string lat:float lng:float image:string
</code></pre>

<p>Since postgresql has support for arrays we'll use that for the menu to keep it
simple.  We need to add a few things to the migration.  We'll set null
constraints on the name, lat, and lng columns as well as provide defaults for
our menu and image.  I'm using an icon from <a href="https://mapicons.mapsmarker.com">Nicolas Mollet</a>.
Feel free to use whatever you wish. And lastly a user_id, since we wan't every
Truck to belong to a User</p>

<pre class="highlight elixir"><code><span class="k">def</span> <span class="n">change</span> <span class="k">do</span>
  <span class="n">create</span> <span class="n">table</span><span class="p">(</span><span class="ss">:trucks</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">add</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>
    <span class="n">add</span> <span class="ss">:menu</span><span class="p">,</span> <span class="p">{</span><span class="ss">:array</span><span class="p">,</span> <span class="ss">:string</span><span class="p">},</span> <span class="ss">default:</span> <span class="p">[]</span>
    <span class="n">add</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:float</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>
    <span class="n">add</span> <span class="ss">:lng</span><span class="p">,</span> <span class="ss">:float</span><span class="p">,</span> <span class="ss">null:</span> <span class="no">false</span>
    <span class="n">add</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">default:</span> <span class="sd">"</span><span class="s2">https://upload.wikimedia.org/wikipedia/commons/7/76/Map_marker_icon_%E2%80%93_Nicolas_Mollet_%E2%80%93_Cold_Food_Checkpoint_%E2%80%93_Sports_%E2%80%93_Gradient.png"</span>
    <span class="n">add</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="n">references</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>

    <span class="n">timestamps</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Edit the model as well to move image and menu to optional fields, as well as
create a relationship between our Truck and User.</p>

<pre class="highlight elixir"><code><span class="c1">#web/models/truck.ex</span>

<span class="n">schema</span> <span class="sd">"</span><span class="s2">trucks"</span> <span class="k">do</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:menu</span><span class="p">,</span> <span class="p">{</span><span class="ss">:array</span><span class="p">,</span> <span class="ss">:string</span><span class="p">}</span>
  <span class="n">field</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:float</span>
  <span class="n">field</span> <span class="ss">:lng</span><span class="p">,</span> <span class="ss">:float</span>
  <span class="n">field</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">User</span>

  <span class="n">timestamps</span>
<span class="k">end</span>

<span class="nv">@required_fields</span> <span class="err">~</span><span class="n">w</span><span class="p">(</span><span class="n">name</span> <span class="n">lat</span> <span class="n">lng</span><span class="p">)</span>
<span class="nv">@optional_fields</span> <span class="err">~</span><span class="n">w</span><span class="p">(</span><span class="n">image</span> <span class="n">menu</span><span class="p">)</span>
</code></pre>

<p>We must add a has_many relationship to the User model as well.</p>

<pre class="highlight elixir"><code><span class="c1">#web/models/user.ex</span>

<span class="n">schema</span> <span class="sd">"</span><span class="s2">users"</span> <span class="k">do</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">field</span> <span class="ss">:password_hash</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">has_many</span> <span class="ss">:trucks</span><span class="p">,</span> <span class="no">Truckn</span><span class="o">.</span><span class="no">Truck</span>

  <span class="n">timestamps</span>
<span class="k">end</span>
</code></pre>

<p>Before we migrate we must add a path for trucks in our router.</p>

<pre class="highlight elixir"><code><span class="c1">#web/router.ex</span>

<span class="n">scope</span> <span class="sd">"</span><span class="s2">/v1"</span> <span class="k">do</span>
  <span class="n">get</span> <span class="sd">"</span><span class="s2">/users"</span><span class="p">,</span> <span class="no">UserController</span><span class="p">,</span> <span class="ss">:show</span>
  <span class="n">resources</span> <span class="sd">"</span><span class="s2">/trucks"</span><span class="p">,</span> <span class="no">TruckController</span>
  <span class="n">post</span> <span class="sd">"</span><span class="s2">/sessions"</span><span class="p">,</span> <span class="no">SessionController</span><span class="p">,</span> <span class="ss">:create</span>
<span class="k">end</span>
</code></pre>

<p>Now we're good to go.</p>

<pre class="highlight shell"><code>mix ecto.migrate
</code></pre>

<p>Let's add our attributes to the TruckView.</p>

<pre class="highlight elixir"><code><span class="c1">#web/views/truck_view.ex</span>

<span class="n">attributes</span> <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:menu</span><span class="p">,</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:lng</span><span class="p">,</span> <span class="ss">:image</span><span class="p">]</span>
</code></pre>

<p>And move our controller to the api/v1/ path</p>

<pre class="highlight shell"><code>mv web/controllers/truck_controller.ex web/controllers/api/v1/truck_controller.ex
</code></pre>

<h2 id="references">References</h2>
<p>https://github.com/AgilionApps/ja_serializer
https://github.com/ueberauth/guardian
https://github.com/elixircnx/comeonin
https://github.com/AgilionApps/ja_serializer/blob/master/lib/ja_serializer/phoenix_view.ex</p>

<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="../../assets/javascripts/application.js"></script>
</body>
</html>
