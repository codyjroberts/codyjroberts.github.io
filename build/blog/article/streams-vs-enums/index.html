<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<title>Streams, Enums, and Protocols!</title>
<link href="../../../assets/stylesheets/application.css" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Radley:400,400italic" rel="stylesheet" />
<link href="//fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" />
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
</head>
<body class='type-system-traditional'>
<div class='blog-wrapper'>
<nav>
<ul class='nav-left'>
<li class='menu-item'>
<span id='namesake'>Cody Roberts</span>
</li>
</ul>
<ul class='nav-right'>
<li>
<span class='menu-item'>
<a href="/blog">blog</a>
</span>
</li>
<li>
<span class='menu-item'>
<a href="/about">about</a>
</span>
</li>
<li>
<span class='menu-item'>
<a href="/projects">projects</a>
</span>
</li>
<li id='hamburger'>
<span class='menu-item'>
<i class='fa fa-bars'></i>
</span>
</li>
</ul>
</nav>

<div class='post-archive'>
<p class='type'>Articles</p>
<div class='post-archive-item'>
<a href="/blog/article/ember-data-in-components/">Ember Data & Components</a>
</div>
<div class='post-archive-item'>
<a href="/blog/article/streams-vs-enums/">Streams, Enums, and Protocols!</a>
</div>
<div class='post-archive-item'>
<a href="/blog/article/a-tour-of-phoenix/">A Tour of Phoenix</a>
</div>
<br>
<p class='type'>Today I Learned</p>
<div class='post-archive-item'>
<a href="/blog/til/comprehensions/">Elixir Comprehensions</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/gen-server/">What is GenServer?</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/elixir-structs/">Elixir Structs</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/atoms/">Elixir Atoms</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/squashing-commits/">Squashing Commits</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/the-reverse-splat/">Ruby's Reverse Splat</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/railroady-uml-diagrams/">Railroady</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/embedding-in-ruby/">Embedding C & Rust in Ruby</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/using-gits-interactive-staging/">Git Interactive</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/select-random-rails-record/">ActiveRecord Random</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/manage-multiple-tmux-sessions/">Tmux Sessions</a>
</div>
<div class='post-archive-item'>
<a href="/blog/til/focused-splits/">Focused Splits</a>
</div>

</div>
<div class='post-wrapper'>
<div class='post-header'>
<p class='date'>Feb 5, 2016</p>
<h2>Streams, Enums, and Protocols!</h2>
<hr>
</div>
<div class='post-content'>
<p>I was initially very confused about the difference between the Enum and Stream
modules in Elixir. If you're also confused, hopefully this short post should
clear it up for you.</p>

<h2 id="enumerable-protocol">Enumerable protocol</h2>

<p>Protocols, as defined by elixir-lang.org, are a mechanism to achieve
polymorphism in Elixir. The Enumerable protocol is a built-in protocol that is
shipped with the language. Both the Enum and Stream modules implement the
Enumerable protocol. To put it simply, this means that they both rely on the same 
standards and can be used in the same manner. Below you can see the
implementation of both Enum.map and Stream.map. Notice the use of the lazy function
in Stream.map. Lazy, also shown below, returns a Stream struct for later use.</p>

<pre class="highlight elixir"><code><span class="c1">#Enum.map</span>
<span class="nv">@spec</span> <span class="n">map</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">element</span> <span class="o">-&gt;</span> <span class="n">any</span><span class="p">))</span> <span class="p">::</span> <span class="n">list</span>
<span class="k">def</span> <span class="n">map</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span> <span class="ow">when</span> <span class="n">is_list</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">for</span> <span class="n">item</span> <span class="o">&lt;-</span> <span class="n">collection</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">fun</span><span class="o">.</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">map</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Enumerable</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="p">{</span><span class="ss">:cont</span><span class="p">,</span> <span class="p">[]},</span> <span class="no">R</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">elem</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="ss">:lists</span><span class="o">.</span><span class="n">reverse</span>
<span class="k">end</span>

<span class="c1">#Stream.map</span>
<span class="nv">@spec</span> <span class="n">map</span><span class="p">(</span><span class="no">Enumerable</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">element</span> <span class="o">-&gt;</span> <span class="n">any</span><span class="p">))</span> <span class="p">::</span> <span class="no">Enumerable</span><span class="o">.</span><span class="n">t</span>
<span class="k">def</span> <span class="n">map</span><span class="p">(</span><span class="n">enum</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">lazy</span> <span class="n">enum</span><span class="p">,</span> <span class="k">fn</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="no">R</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">lazy</span><span class="p">(</span><span class="n">enum</span><span class="p">,</span> <span class="n">fun</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">%</span><span class="no">Stream</span><span class="p">{</span><span class="ss">enum:</span> <span class="n">enum</span><span class="p">,</span> <span class="ss">funs:</span> <span class="p">[</span><span class="n">fun</span><span class="p">]}</span>
</code></pre>

<h2 id="lazy-evaluation">Lazy Evaluation</h2>

<p>Ok, I see it, but what does it mean? Lazy evaluation is a strategy that delays
the evaluation of an expression until the value is needed. This is opposed to
the eager evaluation strategy, often called strict or greedy evaluation. Eager
evaluation, which is the traditional approach taken by most programming languages,
evaluates the expression as soon as it is assigned to a variable. The docs for
Stream give an easy to understand example of this.</p>

<pre class="highlight elixir"><code><span class="n">range</span> <span class="o">=</span> <span class="m">1</span><span class="o">..</span><span class="m">3</span>
<span class="n">stream</span> <span class="o">=</span> <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span> <span class="o">*</span> <span class="m">2</span><span class="p">))</span>
<span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span> <span class="o">+</span> <span class="m">1</span><span class="p">))</span>
<span class="p">[</span><span class="m">3</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">7</span><span class="p">]</span>
</code></pre>

<p>When using Stream.map the range does not get evaluated. The stream variable is
matched to resulted %Stream{} struct on the right hand side which contains the
enum and the function to run on it. It isn't until Enum.map is executed that the
range is evaluated and each item is multiplied by 2 and added to 1. This way we
can prolong computation until the point that it is needed.</p>

<p>This can have a performance increase in some cases when we want to perform many
transformations on a collection. Using Enum to pipe multiple transformations, a
new list would be made at each transformation. If this collection is very large
this could be very expensive. On the other hand if we use Stream to compose the
transformations, we can build a series of transformations that aren't performed
until the end.</p>

<p>Note: Streams are only evaluated when you call a function from the Enum module on it.</p>

</div>
<div class='post-comment'>
<div id='disqus_thread'></div>
<script>
  var disqus_shortname = 'bloomytil';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

</div>

</div>
</div>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="../../../assets/javascripts/application.js"></script>
</body>
</html>
